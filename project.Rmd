---
title: "Final Project"
author: "Karim and Mustafa"
date: "10/27/2022"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# install.packages("Hmisc")
# install.packages("pastecs")
# install.packages("ggplot2")
# install.packages("Hmisc")
# install.packages("fastDummies")
# install.packages("lmtest")
# install.packages("lmtest")
# install.packages("caretEnsemble")
# install.packages("Amelia")
# install.packages("GGally")
```


```{r}
library(ggplot2)
library(psych)
library(corrplot)
library(caret)
library(glmnet)
library(leaps)
library(reshape2)
library(gridExtra)
library(fastDummies)
library(lmtest)
library(pastecs)
library(skimr)
library(tidyverse)
library(caret)
library(caretEnsemble)
library(psych)
library(Amelia)
library(mice)
library(GGally)
library(rpart)
library(randomForest)
library(nnet)
library(ROCR)
library(Metrics)
library(caret)
```




```{r}
# reading file
df = readr::read_csv("caravan-insurance-challenge.csv")
```


# Step 1 Data Visulation and exploration

```{r}
dimension = dim(df)
# total number of observations are 9822
# total number of variables are 87 

totalRows = dimension[1]

str(df)
# data type of 86 variables is number and 1 variable is char, our target variable is number of policies bought remaining variables are categorical numeric.

head(df)
# explore top 5 rows
```

# Descriptive analysis
```{r}
# summary of main data set
stat.desc(df)
summary(df)

# missing values in main data set
paste0("Total missing values:", sum(is.na(df)))
```

```{r}
desc = skim(df)
```


# Out liers
```{r}

```


# Plot graphs
```{r}
library(ggplot2)
library(plyr)



unInsuredRows = df[df$CARAVAN == 0,]
insuredRows = df[df$CARAVAN == 1,]

peopleNotInsuredWithCaravan  = nrow(unInsuredRows);
peopleInsuredWithCaravan = nrow(insuredRows);


ratioOfPeopleWhoDontBought = peopleNotInsuredWithCaravan/totalRows * 100
ratioOfPeopleWhoBought = peopleInsuredWithCaravan/totalRows * 100
# 5.96% who bought insurance vs 94% who didn't buy the insurance, by statistics it looks like company is in loss people are not interested in buying they have to something to improve.

dat <- data.frame(
  policy_status = factor(c("Not Insured","Insured"), levels=c("Not Insured","Insured")),
  Count = c( peopleNotInsuredWithCaravan , peopleInsuredWithCaravan)
)

ggplot(data=dat, aes(x=policy_status, y=Count, fill=policy_status)) +
  geom_bar(colour="red", stat="identity")

```

# Customer Main Type
```{r}
ggplot(df,aes(factor(df$MOSHOOFD))) + 
    geom_bar(aes(fill = factor(df$CARAVAN))) + 
    labs(x="Customer Main type") +
    scale_fill_discrete(name = "CARAVAN") + 
    ggtitle("Caravan Policy based on Customer Main Type") +
    theme(plot.title = element_text(hjust = 0.5))
df$maintype = df$MOSHOOFD

nrow(df[df$maintype == 1 & df$CARAVAN == 1,])
nrow(df[df$maintype == 2 & df$CARAVAN == 1,])
nrow(df[df$maintype == 3 & df$CARAVAN == 1,])
nrow(df[df$maintype == 4 & df$CARAVAN == 1,])
nrow(df[df$maintype == 5 & df$CARAVAN == 1,])
nrow(df[df$maintype == 6 & df$CARAVAN == 1,])
nrow(df[df$maintype == 7 & df$CARAVAN == 1,])
nrow(df[df$maintype == 8 & df$CARAVAN == 1,])
nrow(df[df$maintype == 9 & df$CARAVAN == 1,])
nrow(df[df$maintype == 10 & df$CARAVAN == 1,])

# Here we wanted to see the which customer main type has the highest frequency/count of buying the insurance. Based on results, we see that there are atleast 4 main customer categories that buy insurance. However, for our ease and understanding purposes we will only consider the top 2. This brings us to select, category number 8 and 3, where 8 = Family with grown ups and 3 = Driven Growths
```


# Customer sub type
```{r}
ggplot(df,aes(factor(df$MOSTYPE))) + 
    geom_bar(aes(fill = factor(df$CARAVAN))) + 
    labs(x="Customer Sub type") +
    scale_fill_discrete(name = "CARAVAN") + 
    ggtitle("Policy Bought based on Customer sub Type") +
    theme(plot.title = element_text(hjust = 0.5))

df$subtype = df$MOSTYPE
nrow(df[df$subtype == 33 & df$CARAVAN == 1,])
nrow(df[df$subtype == 8 & df$CARAVAN == 1,])

# category 33 and 8 purchased more policies.
# Based on our main category which compromises of various sub-categories, we can see that sub-categories number 33 and 8 are porne to buying insurance. These should be considered as the characteristics/attributes of the types of customers that exist in the main customer category. hence, we could say that, those who are middle class and those who are low class but have large families have a higher chance of getting the insurance 
```


# Age
```{r}
ggplot(df,aes(factor(df$MGEMLEEF))) + 
    geom_bar(aes(fill = factor(df$CARAVAN))) + 
    geom_text(stat='count', aes(label=..count..), vjust=0) + 
    labs(x="Age Group") +
    scale_fill_discrete(name = "CARAVAN") + 
    ggtitle("Policy bought on age group") +
    theme(plot.title = element_text(hjust = 0.5))

df$age = df$MGEMLEEF
nrow(df[df$age == 1 & df$CARAVAN == 1,])
nrow(df[df$age == 2 & df$CARAVAN == 1,])
nrow(df[df$age == 3 & df$CARAVAN == 1,])
nrow(df[df$age == 4 & df$CARAVAN == 1,])
nrow(df[df$age == 5 & df$CARAVAN == 1,])
nrow(df[df$age == 6 & df$CARAVAN == 1,])

# Here we have explored to see what is the age range of the customers that buy the insurance. Based on our analysis we see that customers who are between the ages 40-50 are prone to buying insurance compared with others. Hence, we could say that it is among the many characteristics of the main customer group [3,8]

```


# No of houses
```{r}
ggplot(df,aes(factor(df$MAANTHUI))) + 
    geom_bar(aes(fill = factor(df$CARAVAN))) + 
    geom_text(stat='count', aes(label=..count..), vjust=0) + 
    labs(x="Number of houses") +
    scale_fill_discrete(name = "CARAVAN") + 
    ggtitle("Number of houses customer has who bought insurance") +
    theme(plot.title = element_text(hjust = 0.5))

df$noofhouses = df$MAANTHUI
nrow(df[df$noofhouses == 1 & df$CARAVAN == 1,])
nrow(df[df$noofhouses == 2 & df$CARAVAN == 1,])
nrow(df[df$noofhouses == 3 & df$CARAVAN == 1,])

# Now we wanted to see who is prone to getting an insurance with respect to number of houses and we have found that customers having at least 1 house are likely to get the insurance.
```


# No of house hold
```{r}
ggplot(df,aes(factor(df$MGEMOMV))) + 
    geom_bar(aes(fill = factor(df$CARAVAN))) + 
    geom_text(stat='count', aes(label=..count..), vjust=0) + 
    labs(x="Number of house hold") +
    scale_fill_discrete(name = "CARAVAN") + 
    ggtitle("Number of house hold") +
    theme(plot.title = element_text(hjust = 0.5))

df$noofhousehold = df$MGEMOMV
nrow(df[df$noofhousehold == 1 & df$CARAVAN == 1,])
nrow(df[df$noofhousehold == 2 & df$CARAVAN == 1,])
nrow(df[df$noofhousehold == 3 & df$CARAVAN == 1,])
df$hasThreeHouseHold = ifelse(df$noofhousehold == 3, 1, 0)
# Now we wanted to see who is prone to getting an insurance with respect to number of houses and we have found that customers having at least 1 house are likely to get the insurance.
```

# Charactertics we found so far
# Customer having 3 house hold
# Customer have one house
# Age of customer is between 40 to 50
# Customer are Driven Growers
# Customer belongs to Lower class large families


# Correlation Analysis
```{r}
corrplot(cor(df[, c("subtype","maintype", "age", "noofhouses", "noofhousehold", "CARAVAN")]), method = "number")


# From the correlation matrix we have below, we have some interesting insights. The reason to run the correlation matrix was to figure out variables of interest which might cause either overfitting or underfitting. # Here we can see that the variables of interest are positively correlated. One exception to this is the correlation between age and number of households. We see that there is a negative correlation between it. Which actually makes sense because, the greater the age, the no of households will decrease. 
```


# Which varaible to select when they are highly postive correlated?

```{r}
plot(df$subtype, df$maintype, main="Scatterplot Between Sub type and main type", xlab="Customer Sub type ", ylab="Customer main type ", pch=19)

sd(df$subtype)
sd(df$maintype)
# Futher we plotted scatter plot and see both variables are highly correlated, we took standard deviation of both variables and sub type having more sd than main type so we can remove main type variable from our regression
```




# Dummies conversion
# Number of Houses
```{r}
table(df$MAANTHUI)

df$MAANTHUI = replace(df$MAANTHUI, df$MAANTHUI > 2, 2)
df$OneHouse = ifelse(df$MAANTHUI ==1, 1, 0)
df$moreThanTwoHouse = ifelse(df$MAANTHUI > 2, 1, 0)


# by looking frequencies of houses we categorized houses into dummies.
```

# Grouping sub customer to meanful customer type.
```{r}
df$averageFamily = ifelse(df$MOSTYPE %in% c(12,11,9,10,13), 1, 0)
df$loners = ifelse(df$MOSTYPE %in% c(17,15,18,16,19), 1, 0)
df$conservativeFamilies = ifelse(df$MOSTYPE %in% c(39,38), 1, 0)
df$crusingSeniors = ifelse(df$MOSTYPE %in% c(26,25,28,27), 1, 0)
df$drivenGrowers = ifelse(df$MOSTYPE %in% c(6,7,8), 1, 0)
df$grownups = ifelse(df$MOSTYPE %in% c(33,34,35,36,37), 1, 0)
df$framers = ifelse(df$MOSTYPE %in% c(40,41), 1, 0)
df$livingWell = ifelse(df$MOSTYPE %in% c(20,21,22,23,24), 1, 0)
df$retired = ifelse(df$MOSTYPE %in% c(29,30,31,32), 1, 0)
df$successful = ifelse(df$MOSTYPE %in% c(1,2,3,4,5), 1, 0)



dat <- data.frame(
  Categorized_Customers = factor(c("averageFamily", "loners", "conservativeFamilies", "crusingSeniors", "drivenGrowers", "grownups", "framers", "livingWell", "retired", "successful"), levels=c("averageFamily", "loners", "conservativeFamilies", "crusingSeniors", "drivenGrowers", "grownups", "framers", "livingWell", "retired", "successful")),
  Count = c( sum(df$averageFamily), sum(df$loners), sum(df$conservativeFamilies), sum(df$crusingSeniors), sum(df$drivenGrowers), sum(df$grownups), sum(df$framers), sum(df$livingWell), sum(df$retired), sum(df$successful) )
)

ggplot(data=dat, aes(x=Categorized_Customers, y=Count, fill=Categorized_Customers)) +
  geom_bar(colour="red", stat="identity")

```


# Income Conversion
```{r}
# Converting 30k income into value
df$MINKM30_c = ifelse(df$MINKM30 == 1, 0.05 * 30000, df$MINKM30)
df$MINKM30_c = ifelse(df$MINKM30_c == 2, 0.17 * 30000, df$MINKM30_c)
df$MINKM30_c = ifelse(df$MINKM30_c == 3, 0.3 * 30000, df$MINKM30_c)
df$MINKM30_c = ifelse(df$MINKM30_c == 4, 0.43 * 30000, df$MINKM30_c)
df$MINKM30_c = ifelse(df$MINKM30_c == 5, 0.56 * 30000, df$MINKM30_c)
df$MINKM30_c = ifelse(df$MINKM30_c == 6, 0.69 * 30000, df$MINKM30_c)
df$MINKM30_c = ifelse(df$MINKM30_c == 7, 0.82 * 30000, df$MINKM30_c)
df$MINKM30_c = ifelse(df$MINKM30_c == 8, 0.94 * 30000, df$MINKM30_c)
df$MINKM30_c = ifelse(df$MINKM30_c == 9, 1 * 30000, df$MINKM30_c)


# Converting 45k income into value
df$MINK3045_c = ifelse(df$MINK3045 == 1, 0.05 * 45000, df$MINK3045)
df$MINK3045_c = ifelse(df$MINK3045_c == 2, 0.17 * 45000, df$MINK3045_c)
df$MINK3045_c = ifelse(df$MINK3045_c == 3, 0.3 * 45000, df$MINK3045_c)
df$MINK3045_c = ifelse(df$MINK3045_c == 4, 0.43 * 45000, df$MINK3045_c)
df$MINK3045_c = ifelse(df$MINK3045_c == 5, 0.56 * 45000, df$MINK3045_c)
df$MINK3045_c = ifelse(df$MINK3045_c == 6, 0.69 * 45000, df$MINK3045_c)
df$MINK3045_c = ifelse(df$MINK3045_c == 7, 0.82 * 45000, df$MINK3045_c)
df$MINK3045_c = ifelse(df$MINK3045_c == 8, 0.94 * 45000, df$MINK3045_c)
df$MINK3045_c = ifelse(df$MINK3045_c == 9, 1 * 45000, df$MINK3045_c)

# Converting 70k income into value
df$MINK4575_c = ifelse(df$MINK4575 == 1, 0.05 * 75000, df$MINK4575)
df$MINK4575_c = ifelse(df$MINK4575_c == 2, 0.17 * 75000, df$MINK4575_c)
df$MINK4575_c = ifelse(df$MINK4575_c == 3, 0.3 * 75000, df$MINK4575_c)
df$MINK4575_c = ifelse(df$MINK4575_c == 4, 0.43 * 75000, df$MINK4575_c)
df$MINK4575_c = ifelse(df$MINK4575_c == 5, 0.56 * 75000, df$MINK4575_c)
df$MINK4575_c = ifelse(df$MINK4575_c == 6, 0.69 * 75000, df$MINK4575_c)
df$MINK4575_c = ifelse(df$MINK4575_c == 7, 0.82 * 75000, df$MINK4575_c)
df$MINK4575_c = ifelse(df$MINK4575_c == 8, 0.94 * 75000, df$MINK4575_c)
df$MINK4575_c = ifelse(df$MINK4575_c == 9, 1 * 75000, df$MINK4575_c)

# Converting 122k income into value
df$MINK7512_c = ifelse(df$MINK7512 == 1, 0.05 * 122000, df$MINK7512)
df$MINK7512_c = ifelse(df$MINK7512_c == 2, 0.17 * 122000, df$MINK7512_c)
df$MINK7512_c = ifelse(df$MINK7512_c == 3, 0.3 * 122000, df$MINK7512_c)
df$MINK7512_c = ifelse(df$MINK7512_c == 4, 0.43 * 122000, df$MINK7512_c)
df$MINK7512_c = ifelse(df$MINK7512_c == 5, 0.56 * 122000, df$MINK7512_c)
df$MINK7512_c = ifelse(df$MINK7512_c == 6, 0.69 * 122000, df$MINK7512_c)
df$MINK7512_c = ifelse(df$MINK7512_c == 7, 0.82 * 122000, df$MINK7512_c)
df$MINK7512_c = ifelse(df$MINK7512_c == 8, 0.94 * 122000, df$MINK7512_c)
df$MINK7512_c = ifelse(df$MINK7512_c == 9, 1 * 122000, df$MINK7512_c)

# Converting 123k income into value
df$MINK123M_c = ifelse(df$MINK123M == 1, 0.05 * 123000, df$MINK123M)
df$MINK123M_c = ifelse(df$MINK123M_c == 2, 0.17 * 123000, df$MINK123M_c)
df$MINK123M_c = ifelse(df$MINK123M_c == 3, 0.3 * 123000, df$MINK123M_c)
df$MINK123M_c = ifelse(df$MINK123M_c == 4, 0.43 * 123000, df$MINK123M_c)
df$MINK123M_c = ifelse(df$MINK123M_c == 5, 0.56 * 123000, df$MINK123M_c)
df$MINK123M_c = ifelse(df$MINK123M_c == 6, 0.69 * 123000, df$MINK123M_c)
df$MINK123M_c = ifelse(df$MINK123M_c == 7, 0.82 * 123000, df$MINK123M_c)
df$MINK123M_c = ifelse(df$MINK123M_c == 8, 0.94 * 123000, df$MINK123M_c)
df$MINK123M_c = ifelse(df$MINK123M_c == 9, 1 * 123000, df$MINK123M_c)

# Average income
df$MINKGEM_c = (df$MINK123M_c + df$MINK7512_c + df$MINK4575_c + df$MINK3045_c + df$MINKM30_c)/5
hist(df$MINKGEM_c)
df$MINKGEM_c

```

# Converting age into numerical.
```{r}
df$MGEMLEEF_c = ifelse(df$MGEMLEEF == 1, 25, df$MGEMLEEF)
df$MGEMLEEF_c = ifelse(df$MGEMLEEF_c == 2, 35, df$MGEMLEEF_c)
df$MGEMLEEF_c = ifelse(df$MGEMLEEF_c == 3, 45, df$MGEMLEEF_c)
df$MGEMLEEF_c = ifelse(df$MGEMLEEF_c == 4, 55, df$MGEMLEEF_c)
df$MGEMLEEF_c = ifelse(df$MGEMLEEF_c == 5, 65, df$MGEMLEEF_c)
df$MGEMLEEF_c = ifelse(df$MGEMLEEF_c == 4, 75, df$MGEMLEEF_c)
```

```{r}
df$MGEMLEEF_c
```



```{r}
# MOSTYPE : customer subtype
# MFWEKIND: Household with children
# MOPLLAAG: Lower level education
# MHHUUR :  Rented house
# MHKOOP :  Home owners
# MINKM30:  Income < 30.000 low income
# MINK7512: Income 75-122.000 high income
# MKOOPKLA: Purchasing power class
# PPERSAUT: Contribution car policies
# CARAVAN:  Number of mobile home policies 0 - 1
```





# Class Im balance problem
```{r}
prop.table(table(df$CARAVAN))
# 94% people didn't buy insurance and only 5% bought. under sampling problem

barplot(prop.table(table(df$CARAVAN)), col = rainbow(2), ylim = c(0,0.7), main = "Class Distribution")
```


# Partition data

```{r}
# training data
df_train = (df[df$ORIGIN == "train",])
df_train = (df_train[,-1])
nrow(df_train)
```


```{r}
#testing data
df_test = (df[df$ORIGIN == "test",])
df_test = (df_test[,-1])
nrow(df_test)
table(df_test$CARAVAN)
```



```{r}
library(ROSE)
over_train = ovun.sample(CARAVAN ~ ., data =df_train, method = "over", N =10948)$data
table(over_train$CARAVAN)
```

```{r}
over_test = ovun.sample(CARAVAN ~ ., data =df_test, method = "over", N =nrow(df_test))$data
table(over_test$CARAVAN)
```



# converting into factor
```{r}
for(i in 1:ncol(over_train)){
over_train[,i] <- as.factor(over_train[,i])
}
```


```{r}
for(i in 1:ncol(over_test)){
over_test[,i] <- as.factor(over_test[,i])
}
```


```{r}
over_test$MGEMOMV
```


```{r}
names(over_train)
```

```{r}
str(over_test$MINKGEM_c)
```

```{r}
over_train$MINKGEM_c = as.numeric(over_train$MINKGEM_c)
over_test$MINKGEM_c = as.numeric(over_test$MINKGEM_c)
```

```{r}
over_train$MGEMOMV = as.numeric(over_train$MGEMOMV)
over_test$MGEMOMV = as.numeric(over_test$MGEMOMV)
```

```{r}
str(over_test$MOSTYPE)
str(over_train$MOSTYPE)
```


# Model 1

```{r}
set.seed(123)

logit.reg = glm(CARAVAN ~ MOSHOOFD + MGEMOMV + OneHouse + MINKGEM_c+MGEMLEEF_c, data = over_train, family = binomial (link = "logit"))
summary(logit.reg)
predicted = predict(logit.reg, over_test, type = "response")
predictedClass = ifelse(predicted>=0.5, 1, 0)
confusionMatrix(as.factor(predictedClass), as.factor(over_test$CARAVAN), positive = "1")
# we did regression with/out house we see a minimal affect i.e with house model is predicting 60 true positives without it's predicting 65 and it's not significant, so we decided not to include this variable.
```

# Building model Correlation 
# Pre processing
```{r}

train_2  = data.frame(df_train[, -c(2,3,4,5)])
zv = apply(train_2, 2, function(x) length(unique(x)) == 1)
dfr = train_2[, !zv]
n=length(colnames(dfr))
correlationMatrix = cor(dfr[,1:n],use="complete.obs")

summary(correlationMatrix[upper.tri(correlationMatrix)])

# After removing our suspected predictors we still have strong positive correlation with 1% and strong negative corelation with 99.9%, we need to find which of them are highly corelated
```

```{r}
high = findCorrelation(correlationMatrix, cutoff = 0.75, names = TRUE)
high
# there are 34 variables which are correlated with each other, before dropping them we need to see how they are correlated with response variable.
```



```{r}
library('rlist')
target_cor_df <- data.frame(V86 = cor(train_2[,sort(high)], df_train[, "CARAVAN"]))


cor_df = target_cor_df[order(target_cor_df$CARAVAN,decreasing = T),,drop=F]
## draw correlation matrix.
#  row.names(cor_df)

excludedVariables = row.names(cor_df[cor_df$CARAVAN < 0.1, ,drop=F])


excludedDummiesAndVariables = list.append(excludedVariables, 'maintype', 'age', 'noofhouses','hasThreeHouseHold', 'moreThanTwoHouse', 'averageFamily', 'loners', 'conservativeFamilies', 'crusingSeniors', 'drivenGrowers', 'grownups', 'framers','livingWell', 'retired', 'successful','MINK7512_c', 'MINK123M_c')

excludedDummiesAndVariables


# There are 33 variables which are less correlated with response variable and having correlation coefficient less than 0.1 so we will exclude them.
```


```{r}
train_3 = data.frame(train_2[, !colnames(train_2) %in% excludedDummiesAndVariables])
names(train_3)
# cor(train_3)
# corrplot(cor(train_3), method = "number")
# 33 + 4 + 1 (carvan) = 38
# around 37 variables have been excluded from set so far next step would be to find good predictors which are not highly correlated and are signicant.
```


```{r}
# corelation between no of car policy and carvan
cor(train_3$APERSAUT, train_3$CARAVAN)
# # corelation between contribution car policies and carvan
cor(train_3$PPERSAUT, train_3$CARAVAN)
# # corelation between  Purchasing power class and carvan
cor(train_3$MKOOPKLA, train_3$CARAVAN)
```


```{r}
cor_response = data.frame("ind_var" = colnames(train_3), "dep_var" = "CARAVAN", "cor_coeff" = 0, "p_values" = 0)

for (i in colnames(train_3)){
    cor_test = cor.test(train_3[, i], train_3[, "CARAVAN"])
    cor_response[cor_response$ind_var == i, "correlation_coefficient"] = cor_test$estimate
    cor_response[cor_response$ind_var == i, "p_values"] = cor_test$p.value
}

cor_response[order(cor_response$cor_coeff, decreasing = T),]
```


```{r}
corrplot(cor(subset(train_3 , select = c(-CARAVAN))), method = "square", type = "upper")
```


```{r}
#  Contribution car policies &  Number of car policies 
cor(train_3$PPERSAUT, train_3$APERSAUT)
# There is a high correlation between car policies and number of car policies we will exclude a variable which has less correlation with response variable.
cor(train_3[ , c("PPERSAUT", "APERSAUT")], train_3[ , "CARAVAN"])
# Contribution car policies is more correlated with response variable so we exclude Number of car policies
train_4 = data.frame(train_3[ , !colnames(train_data_3) %in% c("APERSAUT")])
```


```{r}
colnames(train_4)
```

# Model fiting Model 2
```{r}
set.seed(1234)
shuffle = sample(1:nrow(df_train), nrow(df_train))
```

```{r}
# MFWEKIND  Household with children V15
# MOPLLAAG  Lower level education V18
# MHHUUR Rented house V30
# MINKM30 :  Income < 30.000 V37
# MKOOPKLA:  Purchasing power class V43
# PPERSAUT : Contribution car policies V47
# CARAVAN : CARAVAN V86
glm_2 = data.frame(subset(df_train, select = c("MFWEKIND", "MOPLLAAG", "MHHUUR", "MINKM30", "MKOOPKLA", "PPERSAUT", "CARAVAN")))
glm.2 = glm(CARAVAN ~ ., data = glm_2, family = binomial(link = "logit"))
glm2.summary <- summary(glm.2)
glm2.summary

```


```{r}
# Log likelihood for the null model
glm.2.null = glm.2$null.deviance/-2

# Log likelihood for the proposed model
glm.2.proposed = glm.2$deviance/-2

r_squared_1 <- (glm.2.null - glm.2.proposed) / glm.2.null
r_squared_1
```
# Summary
# 2 variables are highly significant and 2 are slighty significant rest of variables are not signicat at 0.05.
# Lower level education, Rented house and Income < 30.000 have negative influence towards response variable.
# r square value is 0.08346932 from scale of 0 to 1 which is very less so it means predictors we took are not fitting to model hence it's a bad model.




# Model 3 with correlation matrix
```{r}
# its worth to compare model with all predictors vs model 2.
glm_4 = glm(CARAVAN ~  PPERSAUT+MKOOPKLA, data = df_train, family = binomial(link = "logit"))

# summary(glm_5)
#sum.train$rsq

predicted_4 = predict(glm_4, df_train, type = "response")

predictedClass_4 = ifelse(predicted_4>=0.1, 1, 0)
actualClass <- df_train$CARAVAN
LConfusionOutPredicted_5 = table(actualClass, predictedClass_4)
LConfusionOutPredicted_5
```






# Stepwise
```{r}
set.seed(123)

c = over_train[c(1:10, 86)]
step.wise = glm(CARAVAN ~ ., data = c, family = binomial(link = "logit"))
summary(step.wise)
step(step.wise, direction = "both")
```
We Tired running step wise but it wasn't helping as for 10 variable it returns 9. so it's not really reducing no of predictors. I tried even with 20 variables same results. and my machine got stuck if I do with 86 variables.

```{r}
names(df_train)
```


```{r}
corrplot(cor(subset(df_train , select = c("MOSTYPE", "PPERSAUT", "MKOOPKLA", "MAUT1", "MAUT0", "MHKOOP", "CARAVAN"))), method = "number", type = "upper")
```


```{r}

glm_5 = glm(formula = CARAVAN ~ MOSTYPE + PPERSAUT + MKOOPKLA+MAUT1+MAUT0+MHKOOP, family = binomial(link = "logit"), 
    data = over_train)

summary(glm_5)

predicted_5 = predict(glm_5, over_train, type = "response")

predictedClass_5 = ifelse(predicted_5>=0.5, 1, 0)

confusionMatrix(as.factor(predictedClass_5), as.factor(over_train$CARAVAN), positive = "1")

pr <- prediction(predictedClass_5,over_train$CARAVAN)
perf <- performance(pr,measure = "tpr",x.measure = "fpr") 
plot(perf) > auc(over_train$CARAVAN,predictedClass_5)

auc_ROCR <- performance(pr, measure = "auc")
auc_ROCR <- auc_ROCR@y.values[[1]]
auc_ROCR

```
AUC roc plot logistic regression Our AUC score is 0.7176653
